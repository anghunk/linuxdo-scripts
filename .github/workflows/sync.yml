name: Sync Fork with Upstream

on:
  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œ (UTCæ—¶é—´)
  schedule:
    - cron: '0 2 * * 1'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„gitå†å²
          fetch-depth: 0
          # ä½¿ç”¨å…·æœ‰å†™æƒé™çš„token
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“åœ°å€
          git remote add upstream https://github.com/anghunk/linuxdo-scripts.git
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git fetch origin

      - name: Check if sync is needed
        id: check_sync
        run: |
          # æ£€æŸ¥æœ¬åœ°mainåˆ†æ”¯ä¸ä¸Šæ¸¸mainåˆ†æ”¯æ˜¯å¦æœ‰å·®å¼‚
          LOCAL_COMMIT=$(git rev-parse origin/main)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          echo "Local commit: $LOCAL_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "sync_needed=true" >> $GITHUB_OUTPUT
            echo "Sync needed - commits are different"
          else
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            echo "Already in sync - no changes needed"
          fi

      - name: Check and backup release.yml
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦è¿˜æœ‰ release.yml æ–‡ä»¶
          if git cat-file -e upstream/main:.github/workflows/release.yml 2>/dev/null; then
            echo "upstream_has_release=true" >> $GITHUB_ENV
            echo "âœ… ä¸Šæ¸¸ä»æœ‰ release.ymlï¼Œå°†è·Ÿéšä¸Šæ¸¸æ›´æ–°"
          else
            echo "upstream_has_release=false" >> $GITHUB_ENV
            echo "âš ï¸ ä¸Šæ¸¸å·²åˆ é™¤ release.ymlï¼Œå°†ä¿æŠ¤æœ¬åœ°ç‰ˆæœ¬"
            
            # å¤‡ä»½æœ¬åœ°çš„ release.yml
            if [ -f ".github/workflows/release.yml" ]; then
              cp .github/workflows/release.yml /tmp/release.yml.backup
              echo "âœ… å·²å¤‡ä»½æœ¬åœ° release.yml"
            fi
          fi

      - name: Sync with upstream
        if: steps.check_sync.outputs.sync_needed == 'true'
        run: |
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯
          git checkout main
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
          git merge upstream/main --no-edit

      - name: Restore deleted release.yml
        if: steps.check_sync.outputs.sync_needed == 'true' && env.upstream_has_release == 'false'
        run: |
          # åªæœ‰åœ¨ä¸Šæ¸¸åˆ é™¤äº†æ–‡ä»¶æ—¶æ‰æ¢å¤
          if [ -f "/tmp/release.yml.backup" ]; then
            mkdir -p .github/workflows
            cp /tmp/release.yml.backup .github/workflows/release.yml
            git add .github/workflows/release.yml
            git commit -m "ä¿æŠ¤ release.ymlï¼šä¸Šæ¸¸å·²åˆ é™¤ä½†ä¿ç•™æœ¬åœ°ç‰ˆæœ¬"
            echo "âœ… å·²æ¢å¤è¢«åˆ é™¤çš„ release.yml"
          fi
          
          # æ¨é€æ‰€æœ‰æ›´æ”¹åˆ°origin
          git push origin main

      - name: Create pull request for conflicts (if needed)
        if: failure() && steps.check_sync.outputs.sync_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // å¦‚æœåˆå¹¶å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªPRæ¥æ‰‹åŠ¨å¤„ç†å†²çª
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'upstream-sync',
              state: 'open'
            });
            
            // å¦‚æœå·²ç»å­˜åœ¨åŒæ­¥PRï¼Œåˆ™è·³è¿‡
            if (pullRequests.length > 0) {
              console.log('Sync PR already exists');
              return;
            }
            
            // åˆ›å»ºæ–°åˆ†æ”¯ç”¨äºè§£å†³å†²çª
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/heads/upstream-sync',
              sha: context.sha
            });
            
            // åˆ›å»ºPR
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ Sync with upstream (conflicts detected)',
              head: 'upstream-sync',
              base: 'main',
              body: `
              ## è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“å¤±è´¥
              
              åœ¨å°è¯•è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“æ—¶é‡åˆ°äº†å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚
              
              ### è§£å†³æ­¥éª¤ï¼š
              1. åœ¨æœ¬åœ°æ‹‰å–æ­¤åˆ†æ”¯
              2. è§£å†³åˆå¹¶å†²çª
              3. æäº¤æ›´æ”¹
              4. åˆå¹¶æ­¤PR
              
              ### å‘½ä»¤å‚è€ƒï¼š
              \`\`\`bash
              git checkout upstream-sync
              git merge upstream/main
              # è§£å†³å†²çªå
              git add .
              git commit -m "è§£å†³ä¸ä¸Šæ¸¸çš„åˆå¹¶å†²çª"
              git push origin upstream-sync
              \`\`\`
              
              ---
              *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
              `
            });

      - name: Summary
        run: |
          if [ "${{ steps.check_sync.outputs.sync_needed }}" == "true" ]; then
            echo "âœ… Forkå·²æˆåŠŸä¸ä¸Šæ¸¸åŒæ­¥"
          else
            echo "â„¹ï¸ Forkå·²ç»æ˜¯æœ€æ–°çš„ï¼Œæ— éœ€åŒæ­¥"
          fi
